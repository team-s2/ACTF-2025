# AAALLL

## Category
Crypto
## Difficulty
Medium(intend solution)
## Solves
8
## Description
Let’s welcome AAA’s LLL master!
## writeups
题目背景是**partial vandermonde knapsack problem**，预期是**2024Eurocrypt**的**Key Recovery Attack on the Partial  Vandermonde Knapsack Problem**，不过出题的时候没控制好参数(主要电脑配置带不动论文的实验，还忘了有flatter了)，导致出现了很多非预期，其实对应的就是论文里面最trivial的Direct Primal Attack。预期解法需要利用到多项式的输入均为ring下模的多项式g的根。假设这些根是$A=\{x_1,x_2,...,x_n\}$，随机选取其子集$A'$，集合元素个数大概为$t=n/2$，那么期望其中有一半的元素两两互为逆元，即$ab=1\pmod{p}$，然后我们将这些元素两两配对，并观察到在环上有$x^{-1}=-x^{n-1}$，因此：
$$
f(x)=f_0+f_1x+...+f_{n-1}x^{n-1}\\
f(x^{-1})=f_0-f_1x^{n-1}-...-f_{n-1}x
$$
两式相加得到：
$$
f(x)+f(x^{-1})=2f_0+(f_1-f_{n-1})(x-x^{n-1})+...+(f_{n/2-1}-f_{n/2+1})(x^{n/2-1}-x^{n/2+1})
$$
两式相减得到：
$$
f(x)-f(x^{-1})=2(f_1+f_{n-1})(x+x^{n-1})+...+2f_{n/2}x^{n/2}
$$
上面两个多项式的维度只有原来的一半，并且由于f是ternary的多项式，其系数是{-1,0,1}，因此新的两个多项式系数也很小，在格上也是短向量，因此我们分别对上面两个多项式使用Direct Primal Attack，先求kernel然后在kernel上LLL找短向量，找出来之后相加相减就得到了原始的多项式f。
```python
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
from hashlib import md5
from time import time
from Crypto.Util.number import *

def get_pair(roots, p):
    res = []
    tmp = roots.copy()
    
    while len(tmp) != 0:
        for i in range(len(tmp)):
            if (tmp[0]*tmp[i])%p == 1:
                res.append((tmp[0], tmp[i]))
                tmp.remove(tmp[i])
                break
                
        tmp.remove(tmp[0])

    return res

def check(M):
    for i in range(len(M)):
        flag = 1
        for j in [-2, -1, 0, 1, 2]:
            if j not in M[i]:
                flag = 0
        if flag == 1:
            return M[i]

n = 450
p = 3774877201
t = n//2

subset = [1040018022, 3719840057, 2086762603, 3065369513, 3179320758, 891114580, 966265556, 664146925, 1232096603, 1449704729, 2810118429, 2891821810, 698162894, 3070228878, 3114653287, 2793650430, 2941920517, 1811454265, 325024118, 1860481904, 555392385, 2818572232, 3719972491, 981226771, 1777524396, 2717373523, 3694549306, 91210020, 1397236365, 2806262125, 1966653548, 1369610707, 3545263790, 595556443, 1601356313, 2865921937, 2795518764, 1690002428, 3501122295, 2078440315, 1222414863, 1997352805, 271758023, 3348936352, 1800648013, 410072905, 3378691273, 185134810, 1281817316, 821730517, 2855781188, 3353349707, 273754906, 1187616168, 569728457, 401428606, 3671298095, 149603298, 2300569286, 1057503678, 1915386614, 2716934671, 2005635066, 389589525, 2691165686, 586877133, 2874838, 660954102, 3258633701, 1083711515, 1785913794, 3410290851, 1914395297, 2544074509, 3076714307, 2169463229, 2654223166, 3648299978, 3188000068, 1130206965, 875184747, 2549126013, 3602874619, 80327895, 983400559, 2423201604, 3384400899, 654136379, 1835112234, 3302809337, 3388376496, 364586350, 3219484816, 52162306, 3488542302, 2843511894, 638341256, 427235375, 757491483, 3364804296, 172002582, 3112473265, 2746078509, 2118542465, 421527494, 3017385718, 3683667181, 3536621837, 3113923099, 1989065494, 1769242135, 1541932517, 1963422936, 2341204092, 3306256995, 186750428, 1381468653, 1288011784, 229613411, 839241230, 425544589, 2345390466, 2552462338, 286334899, 2984993503, 3741109364, 103579106, 138703348, 2369990075, 2377640836, 1279106009, 2542780598, 1653097443, 3373448595, 2405266494, 3385287676, 289622793, 2376573706, 3096235437, 1971476669, 3449853083, 3565565810, 762810383, 272826480, 516243500, 1710511548, 3233762177, 2013126070, 224313638, 1884110819, 3141861971, 2014729696, 1572103482, 2232944684, 2644670236, 1350302342, 3589742391, 2106163918, 1077036824, 3527373372, 2474464298, 971863088, 1219963894, 3349332612, 1474307915, 905651245, 2666266327, 2192845472, 2748042118, 1489782942, 1300412903, 126577223, 545427793, 360417066, 704648323, 3562938536, 908955264, 1108610874, 247503829, 2379959160, 1059927520, 2869225956, 2202773719, 1498564318, 2032958616, 3485254408, 1091224495, 3287849020, 780873181, 3410363615, 1398303495, 2426564739, 487028181, 1230802692, 139226346, 789883698, 2557862280, 2994004020, 3205148744, 2914199937, 1803400532, 2738281702, 883055391, 1761751131, 1220550272, 1947825121, 3543565567, 1939764967, 2986882625, 798323428, 1120654035, 3722714895, 3679983602, 364513586, 1760147505, 472067864, 2393408548, 2239781327, 799334306, 3497260623, 2769084221, 860677264, 990410164, 3772002363, 2883762621]
values = [712538976, 1225537965, 2633482204, 1245652635, 2529155164, 1672980719, 3024410928, 1535384351, 2252244320, 672919726, 2976916118, 3089453551, 2512277279, 2431400831, 1129198075, 3441247454, 610984549, 2043949242, 3306515233, 2759625250, 2459507335, 2885552592, 3226187015, 983312810, 1815610133, 871259259, 3651562935, 570267317, 2548725905, 70380481, 685470168, 1925389996, 2466124957, 1512923993, 2603725653, 409457162, 859041441, 3193931087, 786021320, 2481319115, 2379423262, 1972220678, 251474531, 448830331, 3189297419, 845468707, 3014186402, 1476144624, 1412175603, 464556671, 1251535251, 2252149066, 3501165225, 1173484383, 1168113959, 2547845342, 3132683037, 182880838, 3236782773, 637440805, 1077834200, 910992912, 1281164705, 763525563, 1025793488, 3031918542, 2457090411, 159146268, 3252417067, 1695150089, 1863899429, 2660689081, 647461624, 3736679821, 2034134877, 973654854, 1545264273, 692989149, 769387639, 2024000598, 2916906076, 1996631367, 2889527392, 527082343, 3319918691, 3629378248, 685639382, 2659312228, 472574946, 1237496521, 434512296, 3649895972, 3500730074, 1092276151, 1513927060, 1179642291, 474879861, 1132457849, 3072787035, 1536862618, 3131879287, 1635514910, 2467715064, 2377496874, 2888951190, 3697148067, 1885811970, 1037114846, 2862197847, 2248493059, 829223452, 17390497, 1063920331, 2504310664, 2269937803, 667770896, 1855657371, 323906741, 2972650844, 3620395133, 2613325861, 2508686438, 2143229100, 977352912, 3380653143, 2367018411, 1665354812, 2473914413, 3531805346, 2023595772, 1909192693, 844059686, 2233570033, 1997039839, 3558799006, 2872633369, 1949018254, 3159312415, 3021409934, 2505867881, 2357897866, 3436059930, 1496867815, 594001374, 3433203342, 2396280741, 2696363547, 1775021594, 434891096, 862244228, 1372573410, 3003385341, 3051290794, 493688483, 2143128679, 394087901, 3668481745, 1085467544, 2438896216, 1782052147, 2415529482, 149721114, 1539904401, 1902915995, 1929333694, 1759980967, 2106193398, 3670877657, 2736025727, 3133082490, 182590224, 1099952929, 3522052498, 2206338880, 1925988633, 3440533747, 25471854, 325651518, 72348028, 3178620735, 3335468600, 818634602, 2932340363, 1163855672, 2453716531, 373827915, 2373018915, 2231504345, 2975884007, 3636085022, 2354093635, 2696203979, 799834661, 2412088324, 1446875965, 3299868618, 302142905, 1957341475, 1522953201, 1257060525, 3769499753, 1591149900, 295691418, 3249943297, 1280379656, 1164820140, 115871117, 219831260, 2505969457, 2618672354, 2781617927, 2886486193, 1648555579, 1265576372, 1720183485, 2424145699, 2772052592, 2399827477, 626825210, 2422432913, 322266950, 2157976175, 2208875362, 2216568965, 3223085486]
ct = b'"\xf2Y\xf0\x15\xc5x\x94\xb9E\xbd\xd3\xa7\xb1\xad\x00\xa2D*+\x87BQ_20\x87\xa2\nP\xfc\xce\x0eW\xaf\xd8-.\xb5\xfai\xf1\xf6*\xben^\xd5'

pairs_x = get_pair(subset, p)
pairs_y = [(values[subset.index(i[0])], values[subset.index(i[1])]) for i in pairs_x]
t1 = len(pairs_x)

assert len(pairs_x) == len(pairs_y)

W1 = []
b1 = []
for i in range(t1):
    basis = [2]
    for j in range(1, n//2):
        basis.append((pow(pairs_x[i][0], j, p) - pow(pairs_x[i][0], n-j, p))%p)
    
    W1.append(basis)
    b1.append((pairs_y[i][0]+pairs_y[i][1])%p)

W1 = matrix(Zmod(p), W1)
b1 = matrix(Zmod(p), b1).T

W1_ = block_matrix([W1, b1], ncols = 2)

kernel = W1_.right_kernel().matrix()
pI = identity_matrix(n//2+1) * p
kernel = kernel.change_ring(ZZ)

M = kernel.stack(pI)

print(M.dimensions())
time1 = time()
ML = M.LLL()
time2 = time()
print("LLL1 time: ", time2-time1)
res1 = check(list(ML))

W2 = []
b2 = []
for i in range(t1):
    basis = []
    for j in range(1, n//2+1):
        basis.append((pow(pairs_x[i][0], j, p) + pow(pairs_x[i][0], n-j, p))%p)
    
    W2.append(basis)
    b2.append((pairs_y[i][0]-pairs_y[i][1])%p)

W2 = matrix(Zmod(p), W2)
b2 = matrix(Zmod(p), b2).T

W2_ = block_matrix([W2, b2], ncols = 2)
kernel = W2_.right_kernel().matrix()

pI = identity_matrix(n//2+1) * p
kernel = kernel.change_ring(ZZ)
M = kernel.stack(pI)
print(M.dimensions())

time1 = time()
ML = M.LLL()
time2 = time()
print("LLL2 time: ", time2-time1)
res2 = check(list(ML))

res1 = res1[:-1]
res2 = res2[:-1]


res1 = [i%p for i in res1]
res2 = [i%p for i in res2]

f0 = res1[0]
f1 = res2[-1]
res1 = res1[1:]
res2 = res2[:-1]
assert len(res1) == len(res2)
left = [(res1[i]+res2[i])*inverse(2, p)%p for i in range(len(res1))]
right = [(res2[i]-res1[i])*inverse(2, p)%p for i in range(len(res1))]
res = [f0] + left + [f1] + right[::-1]
res = [int(i) for i in res]
        
key = md5(str(res).encode()).digest()
aes = AES.new(key = key, mode = AES.MODE_ECB)
print(aes.decrypt(ct))


```